import { useState, useEffect } from 'react';
import { db } from './firebase'; // Ensure Firebase is initialized properly
import { collection, onSnapshot, doc, updateDoc, addDoc } from 'firebase/firestore';
import Chart from 'chart.js/auto';

const Transactions = () => {
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [amount, setAmount] = useState('');
  const [expenseName, setExpenseName] = useState('');

  useEffect(() => {
    const unsubscribe = onSnapshot(collection(db, 'transactions'), (snapshot) => {
      const transData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setTransactions(transData);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const addTransaction = async () => {
    if (!amount || !expenseName) return;
    const newTransaction = { amount: parseFloat(amount), expenseName };
    await addDoc(collection(db, 'transactions'), newTransaction);
    setAmount('');
    setExpenseName('');
  };

  useEffect(() => {
    if (!loading && transactions.length > 0) {
      const ctx = document.getElementById('transactionChart');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: transactions.map(t => t.expenseName),
          datasets: [{
            label: 'Amount (₹)',
            data: transactions.map(t => t.amount),
            backgroundColor: transactions.map(t => t.amount > 0 ? 'green' : 'red'),
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
          }],
        },
      });
    }
  }, [transactions, loading]);

  return (
    <div>
      <h2>Recent Transactions</h2>
      <input 
        type="number" 
        value={amount} 
        onChange={(e) => setAmount(e.target.value)} 
        placeholder="Enter Amount (₹)" 
      />
      <input 
        type="text" 
        value={expenseName} 
        onChange={(e) => setExpenseName(e.target.value)} 
        placeholder="Name of Expense" 
      />
      <button onClick={addTransaction}>Add Transaction</button>
      {loading ? <p>Loading...</p> : (
        <table>
          <thead>
            <tr>
              <th>Name of Expense</th>
              <th>Amount (₹)</th>
            </tr>
          </thead>
          <tbody>
            {transactions.map(txn => (
              <tr key={txn.id} style={{ color: txn.amount > 0 ? 'green' : 'red' }}>
                <td>{txn.expenseName}</td>
                <td>₹{txn.amount}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
      <canvas id="transactionChart"></canvas>
    </div>
  );
};

export default Transactions;
